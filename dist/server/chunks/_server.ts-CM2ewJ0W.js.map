{"version":3,"file":"_server.ts-CM2ewJ0W.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/_api/youtube/_server.ts.js"],"sourcesContent":["import { unlinkSync, writeFileSync, readFileSync } from \"fs\";\nimport { Innertube, UniversalCache } from \"youtubei.js\";\nimport { j as json, e as error } from \"../../../../chunks/index.js\";\nimport yaml from \"js-yaml\";\nlet youtube;\nlet event;\nconst credentialsFilePath = \"./data/youtube_credentials.json\";\nconst POST = async ({ request }) => {\n  const response = await request.json();\n  const message = response?.message;\n  if (message === \"poll\") {\n    return json(event || {});\n  } else if (message === \"logout\") {\n    try {\n      try {\n        await youtube?.session.signOut();\n      } catch (err) {\n        console.error(err);\n      }\n      unlinkSync(credentialsFilePath);\n      const configFilePath = \"./data/configuration.yaml\";\n      let config = await loadFile(configFilePath);\n      if (config?.addons?.youtube) {\n        delete config.addons.youtube;\n        config = yaml.dump(config);\n        writeFileSync(configFilePath, config);\n      }\n      return json({\n        message: \"success\"\n      });\n    } catch (err) {\n      return error(500, err?.message);\n    }\n  } else if (message === \"history\") {\n    try {\n      youtube = await Innertube.create({\n        cache: new UniversalCache(false)\n      });\n      const events = new Promise((resolve) => {\n        if (!youtube) return;\n        youtube.session.on(\"auth-pending\", () => {\n          console.error(\n            \"YouTube credentials have expired, please sign in again or turn off add-on.\"\n          );\n          resolve();\n        });\n        youtube.session.on(\"auth\", async ({ credentials }) => {\n          await saveFile(credentials);\n          resolve();\n        });\n        youtube.session.on(\"update-credentials\", async ({ credentials }) => {\n          await saveFile(credentials);\n          resolve();\n        });\n        youtube.session.on(\"auth-error\", (error2) => {\n          console.error(\"YouTube add-on:\", error2);\n          resolve();\n        });\n      });\n      const auth = await loadFile(credentialsFilePath);\n      await youtube.session.signIn(auth);\n      await events;\n      const library = await youtube.getLibrary();\n      const history = library?.sections?.find((section) => section?.title?.text === \"History\");\n      const video = history?.contents.find((video2) => {\n        return video2.author?.name === response?.media_artist && video2.title?.text === response?.media_title;\n      });\n      const { author, title, id, thumbnails } = video;\n      const getThumbnail = async (id2) => {\n        const url = `https://img.youtube.com/vi/${id2}/maxresdefault.jpg`;\n        const response2 = await fetch(url, { method: \"HEAD\" });\n        if (response2.ok) return url;\n      };\n      const maxres = await getThumbnail(id);\n      return json({\n        media_artist: author?.name,\n        media_title: title?.text,\n        entity_picture: maxres || thumbnails?.[0]?.url\n      });\n    } catch (err) {\n      error(500, err?.message);\n    }\n  }\n  return json({\n    message: \"error\",\n    error: \"Unhandled post request\"\n  });\n};\nconst GET = async () => {\n  try {\n    youtube = await Innertube.create({\n      cache: new UniversalCache(false)\n    });\n    youtube.session.on(\"auth-pending\", (data2) => {\n      event = {\n        message: \"auth-pending\",\n        verification_url: data2?.verification_url,\n        user_code: data2?.user_code,\n        timestamp: (/* @__PURE__ */ new Date()).getTime()\n      };\n    });\n    youtube.session.on(\"auth\", async ({ credentials }) => {\n      event = { message: \"auth\" };\n      await saveFile(credentials);\n    });\n    youtube.session.on(\"update-credentials\", async ({ credentials }) => {\n      event = { message: \"update-credentials\" };\n      await saveFile(credentials);\n    });\n    youtube.session.on(\"auth-error\", (error2) => {\n      event = {\n        message: \"auth-error\",\n        error: error2\n      };\n    });\n    let auth = await loadFile(credentialsFilePath);\n    if (!Object.keys(auth)?.length) auth = void 0;\n    await youtube.session.signIn(auth);\n    const data = await youtube.account.getInfo();\n    event = void 0;\n    return json(data);\n  } catch (err) {\n    console.error(err);\n    return error(500, err.message);\n  }\n};\nasync function loadFile(filePath) {\n  try {\n    const data = readFileSync(filePath, \"utf8\");\n    if (!data.trim()) {\n      return {};\n    } else {\n      return filePath.endsWith(\".yaml\") ? yaml.load(data) : JSON.parse(data);\n    }\n  } catch (err) {\n    if (err?.code === \"ENOENT\") ;\n    else {\n      console.error(`Error reading or parsing ${filePath}:`, err);\n    }\n    return {};\n  }\n}\nasync function saveFile(credentials) {\n  try {\n    const data = JSON.stringify(credentials, null, \"\t\") + \"\\n\";\n    writeFileSync(credentialsFilePath, data);\n  } catch (err) {\n    console.error(\"Failed to save credentials:\", err);\n  }\n}\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}