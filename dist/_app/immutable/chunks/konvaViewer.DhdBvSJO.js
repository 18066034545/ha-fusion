import{K as p,a}from"./konvaBase.Dn1fUOQX.js";import{z as o}from"./scheduler.BGjPv-1J.js";import{s as u,f,c as m}from"./Loader.DbTsSYa5.js";import{c as y}from"./2.DxYEmZCZ.js";class v extends p{constructor(t,e){super(t,e),this.handleMount(),this.subscribeStates()}async handleMount(){this.layer.getChildren(t=>t instanceof a.Shape||t instanceof a.Group).forEach(t=>{var e;!t.isVisible()||this.isGuide(t)?t.remove():(this.handleNodeClick(t),((e=t==null?void 0:t.attrs)==null?void 0:e.type)==="state-label"&&t instanceof a.Text&&this.updateStateLabel(t,void 0))}),await Promise.all(this.layer.find("Image").map(async t=>{if(t instanceof a.Image)switch(t.attrs.type){case"icon":case"state-icon":await this.updateIcon(t);break;case"image":if(await this.updateImage(t,t.getAttr("src"),!1),t.getAttr("id")){const i=t.image();i instanceof HTMLImageElement&&this.updateImageCache(t.getAttr("id"),i)}break}})),await Promise.all(this.layer.find("Image").map(async t=>{t instanceof a.Image&&t.attrs.type==="state-icon"&&await this.updateStateIcon(t,void 0)}))}subscribeStates(){this.unsubscribe=u.subscribe(t=>{this.layer&&t&&this.layer.getChildren(i=>{var s,r;return i.getAttr("entity_id")&&((r=(s=i==null?void 0:i.attrs)==null?void 0:s.type)==null?void 0:r.startsWith("state-"))}).forEach(i=>{i instanceof a.Image?this.updateStateIcon(i,t):i instanceof a.Text&&this.updateStateLabel(i,t)})})}handleNodeClick(t){const e=t.getAttr("onclick");if(t.listening(!!e),t.draggable(!1),t.off("mouseenter mouseleave click tap"),e&&typeof e=="object"){const i=s=>{this.stage.container().style.cursor=o(f)?"unset":s};t.on("mouseenter",()=>i("pointer")),t.on("mouseleave",()=>i("default")),t.on("click tap",async()=>{if(o(f))return;const s=o(m);if(!s){console.error("No connection",s);return}const{domain:r,service:c,data:n,target:l}=e;if(!r||!c){console.error("Invalid service call",e);return}const h=this.stage.getPointerPosition();h&&this.ripple(h.x,h.y);try{await y(s,r,c,n,l)}catch(g){console.error("Error calling service:",g)}})}}async updateLayerChildren(t){this.layer.getChildren(e=>!t.some(i=>{var s;return((s=i==null?void 0:i.attrs)==null?void 0:s.id)===e.getAttr("id")})).forEach(e=>e.destroy()),await Promise.all(t.filter(e=>!this.isGuide(e)).map(async(e,i)=>{var r;let s=this.layer.findOne(`#${(r=e==null?void 0:e.attrs)==null?void 0:r.id}`);if(s?await this.updateNode(s,e):(s=await this.createNode(e),this.layer.add(s)),s&&(s.zIndex(i),s instanceof a.Image&&s.getAttr("id"))){const c=s.image();c instanceof HTMLImageElement&&this.updateImageCache(s.getAttr("id"),c)}}))}async updateNode(t,e){var r,c;const i=(r=e==null?void 0:e.attrs)==null?void 0:r.onclick;t.setAttr("onclick",i?JSON.parse(JSON.stringify(i)):void 0);const s=(c=t==null?void 0:t.attrs)==null?void 0:c.type;s==="state-label"&&t instanceof a.Text?t.setAttrs({...e==null?void 0:e.attrs,text:t.getAttr("text")}):s==="state-icon"&&t instanceof a.Image?t.setAttrs({...e==null?void 0:e.attrs,image:t.getAttr("image"),icon:t.getAttr("icon"),state_color:t.getAttr("state_color")}):t.setAttrs(e==null?void 0:e.attrs),t instanceof a.Image&&(s==="state-icon"?await this.updateStateIcon(t,void 0):s==="icon"?await this.updateIcon(t):s==="image"&&await this.updateImage(t,t.getAttr("src"),!1)),this.handleNodeClick(t)}async createNode(t){let e;const i=t==null?void 0:t.attrs,s=i==null?void 0:i.type;switch(s){case"state-label":e=new a.Text(i),this.updateStateLabel(e,void 0);break;case"state-icon":e=new a.Image(i),this.updateStateIcon(e,void 0);break;case"text":e=new a.Text(i);break;case"icon":e=new a.Image(i),await this.updateIcon(e);break;case"image":e=new a.Image(i),await this.updateImage(e,i==null?void 0:i.src,!1);break;case"rectangle":e=new a.Rect(i);break;case"circle":e=new a.Circle(i);break;case"group":if(e=new a.Group(i),"children"in t&&Array.isArray(t==null?void 0:t.children))for(const r of t.children){const c=await this.createNode(r);e.add(c)}break;default:console.error(s,"type not found"),e=new a.Shape(i)}return this.handleNodeClick(e),e}ripple(t,e){const i=new a.Circle({x:t,y:e,fill:"rgba(255, 255, 255, 0.75)"});this.layer.add(i);const s=380,r=35,c=new a.Animation(n=>{if(!n)return;const l=Math.min(n.time/s,1);i.radius(a.Easings.StrongEaseOut(l,0,r,1)),i.opacity(a.Easings.StrongEaseOut(l,1,-1,1)),l>=1&&(c.stop(),i.destroy())},this.layer).start()}destroyViewer(){var t;(t=this.unsubscribe)==null||t.call(this),super.destroyBase()}}export{v as KonvaViewer};
