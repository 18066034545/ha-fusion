import{a as H,e as j,b as P,n as z,d as C,c as g,A as I,g as N,j as B,k as G,u as J,C as u,w as K,f as Q}from"./scheduler.BGjPv-1J.js";import{S as U,i as X}from"./index.DGGgQIon.js";import{c as Y,H as Z,f as x}from"./Loader.DbTsSYa5.js";function E(s){let t,e,r;return{c(){t=N("video"),this.h()},l(i){t=B(i,"VIDEO",{class:!0});var a=G(t);a.forEach(C),this.h()},h(){t.muted=s[2],t.controls=s[3],t.autoplay=!0,J(t,"class","svelte-1xeckxu"),u(t,"display",s[7]?"none":"initial"),u(t,"width",s[4]?"100%":"calc(14.5rem * 2 + 0.4rem)"),u(t,"object-fit",s[5])},m(i,a){P(i,t,a),s[12](t),e||(r=K(t,"play",s[13]),e=!0)},p(i,a){a&4&&(t.muted=i[2]),a&8&&(t.controls=i[3]),a&128&&u(t,"display",i[7]?"none":"initial"),a&16&&u(t,"width",i[4]?"100%":"calc(14.5rem * 2 + 0.4rem)"),a&32&&u(t,"object-fit",i[5])},d(i){i&&C(t),s[12](null),e=!1,r()}}}function p(s){let t,e=s[0]&&E(s);return{c(){e&&e.c(),t=j()},l(r){e&&e.l(r),t=j()},m(r,i){e&&e.m(r,i),P(r,t,i)},p(r,[i]){r[0]?e?e.p(r,i):(e=E(r),e.c(),e.m(t.parentNode,t)):e&&(e.d(1),e=null)},i:z,o:z,d(r){r&&C(t),e&&e.d(r)}}}function $(s,t,e){let r,i,a;g(s,Y,n=>e(15,r=n)),g(s,Z,n=>e(16,i=n)),g(s,x,n=>e(7,a=n));let{sel:d}=t,{entity:m}=t,{stream_url:f}=t,{muted:R=!0}=t,{loaderVisible:b}=t,{controls:T=!1}=t,{responsive:V=void 0}=t,{size:k}=t,{debug:_}=t,{attachVideo:h}=t,l,y=!1;async function A(){if(!(f||y)){y=!0;try{const n=await L(),o=new RTCPeerConnection(n);o.createDataChannel("dataSendChannel"),o.addTransceiver("audio",{direction:"recvonly"}),o.addTransceiver("video",{direction:"recvonly"});const S=await o.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});await o.setLocalDescription(S);let D="";await new Promise(c=>{o.addEventListener("icecandidate",async W=>{if(!W.candidate){c();return}D+=`a=${W.candidate.candidate}\r
`})});const q=S.sdp+D;let M;try{M=await r.sendMessagePromise({type:"camera/web_rtc_offer",entity_id:m==null?void 0:m.entity_id,offer:q})}catch(c){console.error("Failed to start WebRTC stream:",c==null?void 0:c.message),o.close();return}const w=new MediaStream;o.addEventListener("track",c=>{w.addTrack(c.track),l&&e(6,l.srcObject=w,l),_&&console.debug("WebRTC attached:",d==null?void 0:d.entity_id)}),e(0,f=w);try{await o.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:M.answer}))}catch(c){console.error("Failed to connect WebRTC stream:",c==null?void 0:c.message),o.close();return}}catch(n){console.error(n)}finally{y=!1}}}async function L(){var n;if(!((n=i==null?void 0:i.components)!=null&&n.includes("rtsp_to_webrtc")))return{};try{const o=await r.sendMessagePromise({type:"rtsp_to_webrtc/get_settings"});return!o&&!(o!=null&&o.stun_server)?{}:{iceServers:[{urls:[`stun:${o.stun_server}`]}]}}catch(o){console.error(o)}}function v(){f&&(l&&(e(6,l.src="",l),l.load()),e(0,f=void 0),_&&console.debug("WebRTC detached:",d==null?void 0:d.entity_id))}I(()=>v());function O(n){Q[n?"unshift":"push"](()=>{l=n,e(6,l)})}const F=()=>{e(1,b=!1)};return s.$$set=n=>{"sel"in n&&e(8,d=n.sel),"entity"in n&&e(9,m=n.entity),"stream_url"in n&&e(0,f=n.stream_url),"muted"in n&&e(2,R=n.muted),"loaderVisible"in n&&e(1,b=n.loaderVisible),"controls"in n&&e(3,T=n.controls),"responsive"in n&&e(4,V=n.responsive),"size"in n&&e(5,k=n.size),"debug"in n&&e(10,_=n.debug),"attachVideo"in n&&e(11,h=n.attachVideo)},s.$$.update=()=>{s.$$.dirty&2048&&(h?A():v())},[f,b,R,T,V,k,l,a,d,m,_,h,O,F]}class se extends U{constructor(t){super(),X(this,t,$,p,H,{sel:8,entity:9,stream_url:0,muted:2,loaderVisible:1,controls:3,responsive:4,size:5,debug:10,attachVideo:11})}}export{se as default};
